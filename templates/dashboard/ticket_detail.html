{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% load dashboard2_extras %}

{% block content %}
<div class="w-full max-w-[1184px] mx-auto bg-gray-50 font-['Inter'] pb-24 lg:pb-0">

    <header class="w-full bg-white border-b border-gray-200 p-4 lg:p-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="{% url 'dashboard:tickets' %}" class="text-gray-600 hover:text-gray-800" aria-label="Back to tickets">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </a>
            <div>
                <h1 class="text-lg lg:text-2xl font-bold text-gray-900">Ticket #{{ ticket.id }}</h1>
                <div class="hidden lg:flex items-center flex-wrap gap-3 mt-1">
                    <span class="px-3 py-1 text-xs font-medium text-white bg-{{ ticket_priority_color }} rounded-full">{{ ticket_priority_label }}</span>
                    <span class="px-3 py-1 text-xs font-medium text-{{ ticket_status_color }} bg-{{ ticket_status_color }}/10 rounded-full">{{ ticket_status_label }}</span>
                    <p class="text-sm text-gray-500">Created {{ created_time }}</p>
                </div>
                <p class="text-xs text-gray-600 lg:hidden mt-1">{{ request_type_name }} not working</p>
            </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-4">
            </div>
    </header>

    <div class="w-full p-3 flex justify-between items-center bg-yellow-400/10 border-b border-yellow-400 lg:hidden">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
            <span class="text-sm font-medium text-yellow-500">SLA: {{ ticket.get_time_left }}</span>
        </div>
        <span class="px-3 py-1 text-xs font-medium text-white bg-{{ ticket_priority_color }} rounded-full">{{ ticket_priority_label }}</span>
    </div>

    <main class="p-4 lg:p-6 flex flex-col lg:flex-row gap-6">
        
        <div class="flex-grow flex flex-col gap-6 lg:w-2/3">

            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 lg:p-6">
                <div class="hidden lg:flex items-start gap-4">
                    <img class="w-10 h-10 rounded-full" src="{{ ticket.requester_user.userprofile.avatar_url|default:'/static/images/tickets/default_avatar.png' }}" alt="Requester Avatar" onerror="this.src='/static/images/tickets/default_avatar.png'"/>
                    <div class="w-full">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-base font-semibold text-gray-900">{{ requester_name }}</p>
                                <p class="text-sm text-gray-500">Guest • Room {{ room_number }} • VIP Member</p>
                            </div>
                            <p class="text-sm text-gray-500 flex-shrink-0">{{ created_time }}</p>
                        </div>
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <h3 class="text-base font-semibold text-gray-900">{{ request_type_name }} not working</h3>
                            <p class="mt-2 text-base text-gray-700 leading-relaxed">
                                {{ ticket.notes|default:"No description provided." }}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="block lg:hidden">
                     <h2 class="text-lg font-semibold text-gray-900">Guest Request</h2>
                     <div class="mt-4 space-y-3 text-sm text-gray-800">
                        <p><strong>Room:</strong> {{ room_number }}, Floor {{ floor }} - {{ room_type }}</p>
                        <p><strong>Guest:</strong> {{ requester_name }}</p>
                        <p><strong>Reported:</strong> {{ created_time }}</p>
                     </div>
                     <div class="mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                         <p class="text-sm text-gray-700 leading-relaxed">
                            {{ ticket.notes|default:"No description provided." }}
                         </p>
                     </div>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 lg:p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Attachments</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <a href="#" class="border border-gray-200 rounded-lg p-3 flex items-center gap-3 hover:bg-gray-50">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0"><svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></div>
                        <div>
                            <p class="text-sm lg:text-base font-medium text-gray-900 truncate">thermostat_display.jpg</p>
                            <p class="text-xs lg:text-sm text-gray-500">245 KB</p>
                        </div>
                    </a>
                    <a href="#" class="border border-gray-200 rounded-lg p-3 flex items-center gap-3 hover:bg-gray-50">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center flex-shrink-0"><svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg></div>
                        <div>
                            <p class="text-sm lg:text-base font-medium text-gray-900 truncate">ac_unit_video.mp4</p>
                            <p class="text-xs lg:text-sm text-gray-500">12.3 MB</p>
                        </div>
                    </a>
                </div>
            </section>
            
            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 lg:p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Activity Log</h3>
                <ul class="space-y-4">
                    <li class="flex items-start gap-3"><div class="w-2.5 h-2.5 bg-fuchsia-700 rounded-full mt-1.5 flex-shrink-0"></div><p class="text-sm"><span class="font-medium">Internal comment added</span> by Lisa Park - <span class="text-gray-500">30 minutes ago</span></p></li>
                    <li class="flex items-start gap-3"><div class="w-2.5 h-2.5 bg-teal-500 rounded-full mt-1.5 flex-shrink-0"></div><p class="text-sm"><span class="font-medium">Internal comment added</span> by Mike Chen - <span class="text-gray-500">1 hour ago</span></p></li>
                    <li class="flex items-start gap-3"><div class="w-2.5 h-2.5 bg-yellow-400 rounded-full mt-1.5 flex-shrink-0"></div><p class="text-sm"><span class="font-medium">Priority set to High</span> by John Smith - <span class="text-gray-500">1 hour ago</span></p></li>
                    <li class="flex items-start gap-3"><div class="w-2.5 h-2.5 bg-sky-600 rounded-full mt-1.5 flex-shrink-0"></div><p class="text-sm"><span class="font-medium">Assigned to John Smith</span> by System - <span class="text-gray-500">2 hours ago</span></p></li>
                    <li class="flex items-start gap-3"><div class="w-2.5 h-2.5 bg-red-500 rounded-full mt-1.5 flex-shrink-0"></div><p class="text-sm"><span class="font-medium">Ticket created</span> by {{ requester_name }} - <span class="text-gray-500">2 hours ago</span></p></li>
                </ul>
            </section>
        </div>

        <aside class="hidden lg:flex flex-col gap-6 lg:w-1/3">
            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Workflow Actions</h3>
                <div class="space-y-3">
                    {% if ticket.status == 'pending' %}
                        {% elif ticket.status == 'accepted' and ticket.assignee_user == user %}
                        <button id="startBtn" class="w-full py-2 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600" data-ticket-id="{{ ticket.id }}">Start Work</button>
                    {% elif ticket.status == 'in_progress' and ticket.assignee_user == user %}
                        <button id="completeBtn" class="w-full py-2 text-sm font-medium text-white bg-purple-500 rounded-lg hover:bg-purple-600" data-ticket-id="{{ ticket.id }}">Mark as Completed</button>
                    {% elif ticket.status == 'completed' and user == ticket.requester_user or user.groups.name == 'Front Desk' or user.is_superuser %}
                        <button id="closeBtn" class="w-full py-2 text-sm font-medium text-white bg-green-700 rounded-lg hover:bg-green-800" data-ticket-id="{{ ticket.id }}">Close Ticket</button>
                    {% endif %}
                    
                    {% if ticket.status != 'closed' and ticket.status != 'rejected' %}
                        <button id="escalateBtn" class="w-full py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600" data-ticket-id="{{ ticket.id }}">Escalate Ticket</button>
                        {% if ticket.assignee_user == user or user.is_superuser %}
                            <button id="rejectBtn" class="w-full py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50" data-ticket-id="{{ ticket.id }}">Reject Ticket</button>
                        {% endif %}
                    {% endif %}
                </div>
            </section>
            
            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">SLA Status</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Response SLA</span>
                        <span class="text-sm font-medium {% if ticket.response_sla_breached %}text-red-500{% else %}text-green-500{% endif %}">
                            {% if ticket.response_sla_breached %}Breached{% else %}On Track{% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Resolution SLA</span>
                        <span class="text-sm font-medium {% if ticket.resolution_sla_breached %}text-red-500{% else %}text-green-500{% endif %}">
                            {% if ticket.resolution_sla_breached %}Breached{% else %}On Track{% endif %}
                        </span>
                    </div>
                    <div class="pt-2">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span>Time Elapsed</span>
                            <span>{{ ticket.get_time_left }}</span>
                        </div>
                        <div class="w-full h-2 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full {% if ticket.sla_breached %}bg-red-500{% elif ticket.get_sla_status == 'On Track' %}bg-green-500{% else %}bg-yellow-500{% endif %}" style="width: {% if ticket.sla_breached %}100%{% else %}70%{% endif %}"></div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-base font-semibold text-gray-900 mb-4">Ticket & Room Details</h3>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between"><span class="text-gray-600">Room Number:</span> <span class="font-medium text-gray-900">{{ room_number }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Floor:</span> <span class="font-medium text-gray-900">{{ floor }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Room Type:</span> <span class="font-medium text-gray-900">{{ room_type }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Department:</span> <span class="font-medium text-gray-900">{{ department_name }}</span></div>
                    <div class="flex justify-between"><span class="text-gray-600">Assigned To:</span> <span class="font-medium text-gray-900">{{ assignee_name }}</span></div>
                </div>
            </section>
        </aside>
    </main>
    
    <footer class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 p-4 lg:hidden">
        <div class="grid grid-cols-3 gap-2">
            {% if ticket.status == 'accepted' and ticket.assignee_user == user %}
                <button id="startBtn_mobile" class="col-span-3 w-full py-2 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600" data-ticket-id="{{ ticket.id }}">Start Work</button>
            {% elif ticket.status == 'in_progress' and ticket.assignee_user == user %}
                 <button id="completeBtn_mobile" class="col-span-3 w-full py-2 text-sm font-medium text-white bg-purple-500 rounded-lg hover:bg-purple-600" data-ticket-id="{{ ticket.id }}">Mark as Completed</button>
            {% elif ticket.status == 'completed' and user == ticket.requester_user or user.groups.name == 'Front Desk' or user.is_superuser %}
                 <button id="closeBtn_mobile" class="col-span-3 w-full py-2 text-sm font-medium text-white bg-green-700 rounded-lg hover:bg-green-800" data-ticket-id="{{ ticket.id }}">Close Ticket</button>
            {% endif %}
        </div>
        {% if ticket.status != 'closed' and ticket.status != 'rejected' %}
        <div class="grid grid-cols-2 gap-2 mt-2">
            <button id="escalateBtn_mobile" class="w-full py-2 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600" data-ticket-id="{{ ticket.id }}">Escalate</button>
            
            {% if ticket.assignee_user == user or user.is_superuser %}
                <button id="rejectBtn_mobile" class="w-full py-2 text-sm font-medium text-gray-700 bg-gray-100 border border-gray-300 rounded-lg hover:bg-gray-200" data-ticket-id="{{ ticket.id }}">Reject</button>
            {% endif %}
        </div>
        {% endif %}
    </footer>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Generic function to handle API requests for workflow actions
    function handleWorkflowAction(url, confirmMessage, successMessage, resolutionPrompt = false) {
        let body = null;
        
        if (resolutionPrompt) {
            const resolutionNotes = prompt('Please enter resolution notes:');
            if (resolutionNotes === null) return; // User cancelled
            body = JSON.stringify({ resolution_notes: resolutionNotes });
        } else {
             if (!confirm(confirmMessage)) return;
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: body
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(successMessage);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }

    // Attach event listeners to both desktop and mobile buttons
    function setupButtonListeners(buttonId, url, confirmMessage, successMessage, resolutionPrompt = false) {
        const desktopBtn = document.getElementById(buttonId);
        const mobileBtn = document.getElementById(buttonId + '_mobile');
        
        const action = () => handleWorkflowAction(url, confirmMessage, successMessage, resolutionPrompt);

        if (desktopBtn) desktopBtn.addEventListener('click', action);
        if (mobileBtn) mobileBtn.addEventListener('click', action);
    }
    
    const ticketId = "{{ ticket.id }}";

    setupButtonListeners('startBtn', `/dashboard/api/tickets/${ticketId}/start/`, 'Are you sure you want to start working on this ticket?', 'Work started on ticket!');
    setupButtonListeners('completeBtn', `/dashboard/api/tickets/${ticketId}/complete/`, '', 'Ticket marked as completed!', true);
    setupButtonListeners('closeBtn', `/dashboard/api/tickets/${ticketId}/close/`, 'Are you sure you want to close this ticket?', 'Ticket closed successfully!');
    setupButtonListeners('escalateBtn', `/dashboard/api/tickets/${ticketId}/escalate/`, 'Are you sure you want to escalate this ticket?', 'Ticket escalated successfully!');
    setupButtonListeners('rejectBtn', `/dashboard/api/tickets/${ticketId}/reject/`, 'Are you sure you want to reject this ticket?', 'Ticket rejected successfully!');
});
</script>
{% endblock %}