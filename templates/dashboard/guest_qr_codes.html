{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block title %}Guest QR Codes - Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    .qr-card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        overflow: hidden;
        background: white;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .qr-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    
    .qr-image {
        width: 100%;
        height: 250px;  /* Increased from 200px */
        object-fit: contain;
        background: #f8f9fa;
        padding: 15px;  /* Increased padding */
        cursor: pointer;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .guest-info {
        padding: 15px;
        background: white;
        flex-grow: 1;
    }
    
    .guest-name {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
        font-size: 16px;
    }
    
    .guest-details {
        font-size: 13px;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .status-badge {
        font-size: 11px;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-with-qr {
        background: #d4edda;
        color: #155724;
    }
    
    .status-without-qr {
        background: #f8d7da;
        color: #721c24;
    }
    
    .status-current {
        background: #fff3cd;
        color: #856404;
    }
    
    .card-actions {
        padding: 0 15px 15px;
        display: flex;
        gap: 8px;
    }
    
    .btn-sm {
        font-size: 12px;
        padding: 6px 12px;
        border-radius: 6px;
    }
    
    .statistics-row {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 15px;
        color: white;
        padding: 25px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        text-align: center;
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        padding: 20px;
        backdrop-filter: blur(10px);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: white;
    }
    
    .stat-label {
        font-size: 14px;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .search-filters {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    
    .no-qr-placeholder {
        height: 250px;  /* Increased to match qr-image height */
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: #6c757d;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }
    
    .no-qr-placeholder i {
        font-size: 3rem;
        margin-bottom: 10px;
        opacity: 0.5;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #6c757d;
        margin-bottom: 20px;
    }
    
    .qr-modal-image {
        max-width: 100%;
        max-height: 500px;  /* Increased from 400px */
        object-fit: contain;
        border: 3px solid #007bff;
        border-radius: 12px;
        background: white;
        padding: 20px;
    }
    
    .whatsapp-btn {
        background-color: #25D366;
        border-color: #25D366;
        color: white;
    }
    
    .whatsapp-btn:hover {
        background-color: #128C7E;
        border-color: #128C7E;
        color: white;
    }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">
                <i class="fas fa-qrcode me-2"></i>Guest QR Codes
            </h1>
            <p class="text-muted mb-0">Manage and view all guest QR codes</p>
        </div>
        <div>
            <a href="{% url 'register_guest' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Register New Guest
            </a>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="statistics-row">
        <div class="row">
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number">{{ total_guests }}</div>
                    <div class="stat-label">Total Guests</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number">{{ guests_with_qr }}</div>
                    <div class="stat-label">With QR Codes</div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card">
                    <div class="stat-number">{{ guests_without_qr }}</div>
                    <div class="stat-label">Without QR Codes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filters -->
    <div class="search-filters">
        <form method="GET" class="row g-3">
            <div class="col-md-6">
                <label for="search" class="form-label">Search Guests</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="search" name="search" 
                           value="{{ search }}" placeholder="Search by name, room, email, or phone...">
                </div>
            </div>
            <div class="col-md-4">
                <label for="filter" class="form-label">Filter by Status</label>
                <select class="form-select" id="filter" name="filter">
                    <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All Guests</option>
                    <option value="with_qr" {% if filter_status == 'with_qr' %}selected{% endif %}>With QR Codes</option>
                    <option value="without_qr" {% if filter_status == 'without_qr' %}selected{% endif %}>Without QR Codes</option>
                    <option value="current" {% if filter_status == 'current' %}selected{% endif %}>Current Guests</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-filter me-2"></i>Filter
                    </button>
                </div>
            </div>
        </form>
    </div>

    {% if guests %}
        <!-- QR Codes Grid -->
        <div class="row g-4">
            {% for guest in guests %}
                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                    <div class="qr-card h-100">
                        <!-- QR Code Image -->
                        {% if guest.details_qr_code %}
                            <img src="data:image/png;base64,{{ guest.details_qr_code }}" alt="QR Code for {{ guest.full_name }}" 
                                 class="qr-image" onclick="showQRModal('data:image/png;base64,{{ guest.details_qr_code }}', '{{ guest.full_name }}', '{{ guest.id }}', '{{ guest.phone|default:"" }}', '{{ guest.guest_id }}', '{{ guest.room_number|default:"" }}', '{{ guest.checkin_date|date:"M d, Y"|default:"" }}', '{{ guest.checkout_date|date:"M d, Y"|default:"" }}', '{{ guest.breakfast_included|yesno:"Included,Not Included" }}')">
                        {% else %}
                            <div class="no-qr-placeholder">
                                <i class="fas fa-qrcode"></i>
                                <small>No QR Code</small>
                            </div>
                        {% endif %}
                        
                        <!-- Guest Information -->
                        <div class="guest-info">
                            <div class="guest-name">{{ guest.full_name }}</div>
                            <div class="guest-details">
                                <i class="fas fa-id-card me-1"></i>{{ guest.guest_id }}
                            </div>
                            {% if guest.room_number %}
                            <div class="guest-details">
                                <i class="fas fa-door-open me-1"></i>Room {{ guest.room_number }}
                            </div>
                            {% endif %}
                            {% if guest.phone %}
                            <div class="guest-details">
                                <i class="fas fa-phone me-1"></i>{{ guest.phone }}
                            </div>
                            {% endif %}
                            <div class="guest-details">
                                <i class="fas fa-calendar me-1"></i>{{ guest.created_at|date:"M d, Y" }}
                            </div>
                            
                            <!-- Status Badge -->
                            <div class="mt-2">
                                {% if guest.details_qr_code %}
                                    <span class="status-badge status-with-qr">
                                        <i class="fas fa-check me-1"></i>Has QR Code
                                    </span>
                                {% else %}
                                    <span class="status-badge status-without-qr">
                                        <i class="fas fa-times me-1"></i>No QR Code
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="card-actions">
                            {% if guest.details_qr_code %}
                                <button type="button" class="btn btn-info btn-sm" 
                                        onclick="showQRModal('data:image/png;base64,{{ guest.details_qr_code }}', '{{ guest.full_name }}', '{{ guest.id }}', '{{ guest.phone|default:"" }}', '{{ guest.guest_id }}', '{{ guest.room_number|default:"" }}', '{{ guest.checkin_date|date:"M d, Y"|default:"" }}', '{{ guest.checkout_date|date:"M d, Y"|default:"" }}', '{{ guest.breakfast_included|yesno:"Included,Not Included" }}')">
                                    <i class="fas fa-eye me-1"></i>Show QR
                                </button>
                                <a href="data:image/png;base64,{{ guest.details_qr_code }}" download="qr_{{ guest.guest_id }}.png" 
                                   class="btn btn-success btn-sm">
                                    <i class="fas fa-download me-1"></i>Download
                                </a>
                                <button type="button" class="btn btn-warning btn-sm" 
                                        data-bs-toggle="modal" data-bs-target="#regenerateModal{{ guest.id }}">
                                    <i class="fas fa-sync me-1"></i>Regenerate
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-primary btn-sm" 
                                        data-bs-toggle="modal" data-bs-target="#generateModal{{ guest.id }}">
                                    <i class="fas fa-qrcode me-1"></i>Generate QR
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Regenerate QR Modal -->
                <div class="modal fade" id="regenerateModal{{ guest.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Regenerate QR Code</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="POST" action="{% url 'dashboard:regenerate_guest_qr' guest.id %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <p>Regenerate QR code for <strong>{{ guest.full_name }}</strong>?</p>
                                    <div class="mb-3">
                                        <label for="qr_size{{ guest.id }}" class="form-label">QR Code Size</label>
                                        <select class="form-select" name="qr_size" id="qr_size{{ guest.id }}">
                                            <option value="large">Large (Good for Tablets)</option>
                                            <option value="xlarge" selected>Extra Large (Recommended)</option>
                                            <option value="xxlarge">XXL (Best for Low-Res Cameras)</option>
                                            <option value="xxxlarge">XXXL (Maximum Size)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-sync me-2"></i>Regenerate
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Generate QR Modal -->
                <div class="modal fade" id="generateModal{{ guest.id }}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Generate QR Code</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="POST" action="{% url 'dashboard:regenerate_guest_qr' guest.id %}">
                                {% csrf_token %}
                                <div class="modal-body">
                                    <p>Generate QR code for <strong>{{ guest.full_name }}</strong>?</p>
                                    <div class="mb-3">
                                        <label for="qr_size_gen{{ guest.id }}" class="form-label">QR Code Size</label>
                                        <select class="form-select" name="qr_size" id="qr_size_gen{{ guest.id }}">
                                            <option value="large">Large (Good for Tablets)</option>
                                            <option value="xlarge" selected>Extra Large (Recommended)</option>
                                            <option value="xxlarge">XXL (Best for Low-Res Cameras)</option>
                                            <option value="xxxlarge">XXXL (Maximum Size)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-qrcode me-2"></i>Generate
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <!-- Empty State -->
        <div class="empty-state">
            <i class="fas fa-qrcode"></i>
            <h4>No Guests Found</h4>
            <p class="text-muted">
                {% if search or filter_status != 'all' %}
                    No guests match your search criteria. Try adjusting your filters.
                {% else %}
                    No guests have been registered yet.
                {% endif %}
            </p>
            {% if not search and filter_status == 'all' %}
                <a href="{% url 'register_guest' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Register First Guest
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- QR Code Display Modal -->
<div class="modal fade" id="qrDisplayModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalTitle">Guest QR Code</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="qrModalImage" src="" alt="QR Code" class="qr-modal-image mb-3">
                <p id="qrModalGuestName" class="text-muted"></p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn whatsapp-btn" onclick="shareOnWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>Share on WhatsApp
                </button>
                <a id="qrDownloadLink" href="" download="" class="btn btn-success">
                    <i class="fas fa-download me-2"></i>Download
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // QR Modal functionality
    let currentQRData = {};
    
    function showQRModal(qrUrl, guestName, guestId, guestPhone, guestIdCode, roomNumber, checkinDate, checkoutDate, breakfastStatus) {
        currentQRData = {
            url: qrUrl,
            guestName: guestName,
            guestId: guestId,
            guestPhone: guestPhone || '',
            guestIdCode: guestIdCode || '',
            roomNumber: roomNumber || 'Not assigned',
            checkinDate: checkinDate || 'Not set',
            checkoutDate: checkoutDate || 'Not set',
            breakfastStatus: breakfastStatus || 'Not specified'
        };
        
        document.getElementById('qrModalImage').src = qrUrl;
        document.getElementById('qrModalGuestName').textContent = `QR Code for ${guestName}`;
        document.getElementById('qrDownloadLink').href = qrUrl;
        document.getElementById('qrDownloadLink').download = `qr_${guestId}.png`;
        
        const modal = new bootstrap.Modal(document.getElementById('qrDisplayModal'));
        modal.show();
    }
    
    function shareOnWhatsApp() {
        if (!currentQRData.url) return;
        
        const guestPhone = currentQRData.guestPhone;
        if (!guestPhone) {
            alert('No phone number available for this guest. Please add a phone number to share via WhatsApp.');
            return;
        }
        
        // Show loading state
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
        btn.disabled = true;
        
        // Try WhatsApp Business API first
        fetch(`/dashboard/guest-qr-codes/${currentQRData.guestId}/share-whatsapp/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ ' + data.message);
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('qrDisplayModal'));
                if (modal) modal.hide();
            } else {
                // Fallback to wa.me URL with formatted message
                console.log('WhatsApp API failed, trying fallback method...');
                return fallbackWhatsAppShare(currentQRData.guestId);
            }
        })
        .catch(error => {
            console.error('WhatsApp API Error:', error);
            // Fallback to wa.me URL
            return fallbackWhatsAppShare(currentQRData.guestId);
        })
        .finally(() => {
            // Restore button state
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    
    function fallbackWhatsAppShare(guestId) {
        // Get formatted message from backend
        fetch(`/dashboard/guest-qr-codes/${guestId}/whatsapp-message/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Open WhatsApp with formatted message
                const waUrl = `https://wa.me/${data.phone}?text=${encodeURIComponent(data.message)}`;
                window.open(waUrl, '_blank');
                alert('üì± WhatsApp opened with guest details. The QR code image needs to be shared separately.');
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('qrDisplayModal'));
                if (modal) modal.hide();
            } else {
                alert('‚ùå Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Fallback Error:', error);
            alert('‚ùå Failed to prepare WhatsApp message. Please try again.');
        });
    }
    // Auto-submit form on filter change
    document.getElementById('filter').addEventListener('change', function() {
        this.form.submit();
    });
    
    // Clear search on double click
    document.getElementById('search').addEventListener('dblclick', function() {
        this.value = '';
        this.form.submit();
    });
    
    // Toast notifications for messages
    {% if messages %}
        {% for message in messages %}
            (function() {
                // Show toast notification
                var toastHtml = '<div class="toast align-items-center text-white bg-{{ message.tags }} border-0" role="alert">' +
                    '<div class="d-flex">' +
                    '<div class="toast-body">{{ message|escapejs }}</div>' +
                    '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
                    '</div>' +
                    '</div>';
                
                // Create toast container if it doesn't exist
                var toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }
                
                // Add toast
                toastContainer.insertAdjacentHTML('beforeend', toastHtml);
                
                // Show toast
                var toastElement = toastContainer.lastElementChild;
                var toast = new bootstrap.Toast(toastElement);
                toast.show();
                
                // Remove toast after it's hidden
                toastElement.addEventListener('hidden.bs.toast', function() {
                    this.remove();
                });
            })();
        {% endfor %}
    {% endif %}
</script>
{% endblock %}