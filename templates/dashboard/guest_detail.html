{% extends "dashboard/base_dashboard.html" %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block dashboard_content %}
<!-- Breadcrumb Navigation -->
<nav aria-label="breadcrumb" class="mb-4">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{% url 'dashboard:main' %}">Dashboard</a>
    </li>
    <li class="breadcrumb-item">
      <a href="{% url 'dashboard:guests' %}">Guests</a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      {{ guest.full_name|default:"Guest Details" }}
    </li>
  </ol>
</nav>

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-bold">
    <i class="bi bi-person-circle text-primary"></i>
    Guest Details
  </h2>
  <div class="btn-group" role="group">
    <a href="{% url 'dashboard:guests' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Guests
    </a>
    <button
      type="button"
      class="btn btn-primary dropdown-toggle"
      data-bs-toggle="dropdown"
    >
      <i class="bi bi-gear"></i> Actions
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#"
          ><i class="bi bi-pencil"></i> Edit Guest</a
        >
      </li>
      <li>
        <a class="dropdown-item" href="#"
          ><i class="bi bi-ticket"></i> Issue Voucher</a
        >
      </li>
      <li><hr class="dropdown-divider" /></li>
      <li>
        <a class="dropdown-item text-danger" href="#"
          ><i class="bi bi-trash"></i> Delete Guest</a
        >
      </li>
    </ul>
  </div>
</div>

<!-- Guest Information Card -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-person-badge"></i> Guest Information
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-4">Full Name:</dt>
              <dd class="col-sm-8">
                {{ guest.full_name|default:"Not provided" }}
              </dd>

              <dt class="col-sm-4">Guest ID:</dt>
              <dd class="col-sm-8">
                <span class="badge bg-secondary"
                  >{{ guest.guest_id|default:"Auto-generated" }}</span
                >
              </dd>

              <dt class="col-sm-4">Email:</dt>
              <dd class="col-sm-8">
                {% if guest.email %}
                <a href="mailto:{{ guest.email }}">{{ guest.email }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
              </dd>

              <dt class="col-sm-4">Phone:</dt>
              <dd class="col-sm-8">
                {% if guest.phone %}
                <a href="tel:{{ guest.phone }}">{{ guest.phone }}</a>
                {% else %}
                <span class="text-muted">Not provided</span>
                {% endif %}
              </dd>
            </dl>
          </div>
          <div class="col-md-6">
            <dl class="row">
              <dt class="col-sm-4">Room:</dt>
              <dd class="col-sm-8">
                <span class="badge bg-info fs-6"
                  >{{ guest.room_number|default:"Not assigned" }}</span
                >
              </dd>

              <dt class="col-sm-4">Check-in:</dt>
              <dd class="col-sm-8">
                {% if guest.checkin_date %}
                  {{ guest.checkin_date|date:"M d, Y" }}
                {% else %}
                  <span class="text-muted">Not set</span>
                {% endif %}
              </dd>

              <dt class="col-sm-4">Check-out:</dt>
              <dd class="col-sm-8">
                {% if guest.checkout_date %}
                  {{ guest.checkout_date|date:"M d, Y" }}
                {% else %}
                  <span class="text-muted">Not set</span>
                {% endif %}
              </dd>

              <dt class="col-sm-4">Breakfast:</dt>
              <dd class="col-sm-8">
                {% if guest.breakfast_included %}
                <span class="badge bg-success">Included</span>
                {% else %}
                <span class="badge bg-secondary">Not Included</span>
                {% endif %}
              </dd>
            </dl>
          </div>
        </div>
        {% if guest.package_type %}
        <div class="row mt-3">
          <div class="col-12">
            <dt>Package Type:</dt>
            <dd>
              <span class="badge bg-warning text-dark"
                >{{ guest.package_type }}</span
              >
            </dd>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Quick Stats -->
  <div class="col-lg-4">
    <!-- Guest QR Code Card -->
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-info text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-qr-code"></i> Guest QR Code
        </h5>
      </div>
      <div class="card-body text-center">
        {% if guest.details_qr_code %}
          <img src="data:image/png;base64,{{ guest.details_qr_code }}" alt="Guest QR Code" 
               class="img-fluid border rounded mb-3" 
               style="max-width: 200px; cursor: pointer;"
               onclick="showGuestQRModal('data:image/png;base64,{{ guest.details_qr_code }}', '{{ guest.full_name }}', '{{ guest.id }}', '{{ guest.phone|default:"" }}')">
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-primary btn-sm" 
                    onclick="showGuestQRModal('data:image/png;base64,{{ guest.details_qr_code }}', '{{ guest.full_name }}', '{{ guest.id }}', '{{ guest.phone|default:"" }}')">
              <i class="bi bi-eye"></i> View QR Code
            </button>
            <a href="data:image/png;base64,{{ guest.details_qr_code }}" download="guest_qr_{{ guest.guest_id }}.png" 
               class="btn btn-success btn-sm">
              <i class="bi bi-download"></i> Download
            </a>
            <button type="button" class="btn btn-outline-secondary btn-sm" 
                    onclick="shareGuestQR('data:image/png;base64,{{ guest.details_qr_code }}', '{{ guest.full_name }}', '{{ guest.phone|default:"" }}')">
              <i class="fab fa-whatsapp"></i> Share via WhatsApp
            </button>
          </div>
        {% else %}
          <div class="text-muted">
            <i class="bi bi-qr-code fs-1 mb-3"></i>
            <p>No QR code generated for this guest yet.</p>
            <button type="button" class="btn btn-primary btn-sm" 
                    data-bs-toggle="modal" data-bs-target="#generateQRModal">
              <i class="bi bi-qr-code"></i> Generate QR Code
            </button>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Quick Stats Card -->
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="card-title mb-0">
          <i class="bi bi-graph-up"></i> Quick Stats
        </h5>
      </div>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span>Total Vouchers:</span>
          <span class="badge bg-primary fs-6">{{ vouchers.count }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span>Active Vouchers:</span>
          <span class="badge bg-success fs-6">{{ vouchers|length }}</span>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <span>Stay Duration:</span>
          <span class="badge bg-info fs-6">
            {{ stay_duration|default:"N/A" }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Vouchers Section -->
<div class="card shadow-sm">
  <div
    class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"
  >
    <h5 class="card-title mb-0">
      <i class="bi bi-ticket-perforated"></i> Vouchers ({{ vouchers.count }})
    </h5>
    <button class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle"></i> Issue New Voucher
    </button>
  </div>
  <div class="card-body">
    {% if vouchers %}
    <div class="table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Code</th>
            <th>Type</th>
            <th>Status</th>
            <th>Valid From</th>
            <th>Valid To</th>
            <th>Quantity</th>
            <th>QR Code</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for voucher in vouchers %}
          <tr>
            <td>
              <code class="bg-light p-1 rounded"
                >{{ voucher.voucher_code }}</code
              >
            </td>
            <td>
              <span class="badge bg-info"
                >{{ voucher.get_voucher_type_display }}</span
              >
            </td>
            <td>
              {% if voucher.status == 'active' %}
              <span class="badge bg-success"
                >{{ voucher.get_status_display }}</span
              >
              {% elif voucher.status == 'redeemed' %}
              <span class="badge bg-primary"
                >{{ voucher.get_status_display }}</span
              >
              {% elif voucher.status == 'expired' %}
              <span class="badge bg-warning"
                >{{ voucher.get_status_display }}</span
              >
              {% else %}
              <span class="badge bg-secondary"
                >{{ voucher.get_status_display }}</span
              >
              {% endif %}
            </td>
            <td>
              {% if voucher.valid_from %} {{ voucher.valid_from|date:"M d, Y" }}
              {% else %}
              <span class="text-muted">Not set</span>
              {% endif %}
            </td>
            <td>
              {% if voucher.valid_to %}
                {{ voucher.valid_to|date:"M d, Y" }}
              {% else %}
                <span class="text-muted">Not set</span>
              {% endif %}
            </td>
            <td>
              <span class="badge bg-secondary">{{ voucher.quantity }}</span>
            </td>
            <td>
              {% if voucher.qr_image %}
              <button
                class="btn btn-sm btn-outline-primary"
                data-bs-toggle="modal"
                data-bs-target="#qrModal{{ voucher.id }}"
              >
                <i class="bi bi-qr-code"></i> View QR
              </button>
              {% else %}
              <span class="text-muted">No QR</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <a
                  href="{% url 'dashboard:voucher_detail' voucher.id %}"
                  class="btn btn-outline-primary"
                >
                  <i class="bi bi-eye"></i>
                </a>
                <button class="btn btn-outline-warning">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- QR Code Modal for each voucher -->
          {% if voucher.qr_image %}
          <div class="modal fade" id="qrModal{{ voucher.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">
                    QR Code - {{ voucher.voucher_code }}
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                  ></button>
                </div>
                <div class="modal-body text-center">
                  <img
                    src="data:image/png;base64,{{ voucher.qr_image }}"
                    alt="QR Code"
                    class="img-fluid border rounded"
                    style="max-width: 300px"
                  />
                  <p class="mt-3 text-muted">
                    {{ voucher.get_voucher_type_display }} - {{ voucher.get_status_display }}
                  </p>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Close
                  </button>
                  <a
                    href="data:image/png;base64,{{ voucher.qr_image }}"
                    download
                    class="btn btn-primary"
                  >
                    <i class="bi bi-download"></i> Download
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endif %} {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-5">
      <div class="text-muted">
        <i class="bi bi-ticket-perforated fs-1"></i>
        <p class="mt-3">No vouchers issued for this guest yet.</p>
        <button class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Issue First Voucher
        </button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Timeline/Activity Section -->
<div class="card shadow-sm mt-4">
  <div class="card-header bg-info text-white">
    <h5 class="card-title mb-0">
      <i class="bi bi-clock-history"></i> Recent Activity
    </h5>
  </div>
  <div class="card-body">
    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-marker bg-success"></div>
        <div class="timeline-content">
          <h6 class="timeline-title">Guest Registered</h6>
          <p class="timeline-text text-muted">
            {{ guest.created_at|date:"M d, Y \a\t g:i A" }}
          </p>
        </div>
      </div>
      {% for voucher in vouchers|slice:":3" %}
      <div class="timeline-item">
        <div class="timeline-marker bg-primary"></div>
        <div class="timeline-content">
          <h6 class="timeline-title">Voucher Issued</h6>
          <p class="timeline-text text-muted">
            {{ voucher.get_voucher_type_display }} voucher created
          </p>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .timeline {
    position: relative;
    padding-left: 30px;
  }

  .timeline::before {
    content: "";
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
  }

  .timeline-item {
    position: relative;
    margin-bottom: 20px;
  }

  .timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
  }

  .timeline-content {
    padding-left: 15px;
  }

  .timeline-title {
    margin-bottom: 5px;
    font-weight: 600;
  }

  .timeline-text {
    margin-bottom: 0;
    font-size: 0.9rem;
  }
  
  .whatsapp-btn {
    background-color: #25D366;
    border-color: #25D366;
    color: white;
  }
  
  .whatsapp-btn:hover {
    background-color: #128C7E;
    border-color: #128C7E;
    color: white;
  }
</style>

<!-- Guest QR Code Display Modal -->
<div class="modal fade" id="guestQRDisplayModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="guestQRModalTitle">Guest QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="guestQRModalImage" src="" alt="Guest QR Code" class="img-fluid mb-3" style="max-width: 300px;">
        <p id="guestQRModalGuestName" class="text-muted"></p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn whatsapp-btn" onclick="shareCurrentGuestQR()">
          <i class="fab fa-whatsapp me-2"></i>Share on WhatsApp
        </button>
        <a id="guestQRDownloadLink" href="" download="" class="btn btn-success">
          <i class="bi bi-download me-2"></i>Download
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generate QR Code Modal -->
<div class="modal fade" id="generateQRModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Generate QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{% url 'dashboard:regenerate_guest_qr' guest.id %}">
        {% csrf_token %}
        <div class="modal-body">
          <p>Generate QR code for <strong>{{ guest.full_name }}</strong>?</p>
          <div class="mb-3">
            <label for="qr_size_gen" class="form-label">QR Code Size</label>
            <select class="form-select" name="qr_size" id="qr_size_gen">
              <option value="medium">Medium (Compact)</option>
              <option value="large">Large (Recommended)</option>
              <option value="xlarge" selected>Extra Large (Easy Scanning)</option>
              <option value="xxlarge">XXL (Very Large)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">
            <i class="bi bi-qr-code me-2"></i>Generate QR Code
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Guest QR Code functionality
  let currentGuestQRData = {};
  
  function showGuestQRModal(qrUrl, guestName, guestId, guestPhone) {
    currentGuestQRData = {
      url: qrUrl,
      guestName: guestName,
      guestId: guestId,
      guestPhone: guestPhone || ''
    };
    
    document.getElementById('guestQRModalImage').src = qrUrl;
    document.getElementById('guestQRModalGuestName').textContent = 'QR Code for ' + guestName;
    document.getElementById('guestQRDownloadLink').href = qrUrl;
    document.getElementById('guestQRDownloadLink').download = 'guest_qr_' + guestId + '.png';
    
    const modal = new bootstrap.Modal(document.getElementById('guestQRDisplayModal'));
    modal.show();
  }
  
  function shareGuestQR(qrUrl, guestName, guestPhone) {
    if (!guestPhone) {
      alert('No phone number available for this guest. Please add a phone number to share via WhatsApp.');
      return;
    }
    
    // Get guest ID from current page
    const guestId = '{{ guest.id }}';
    
    // Show loading state
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    btn.disabled = true;
    
    // Try WhatsApp Business API first
    fetch(`/dashboard/guest-qr-codes/${guestId}/share-whatsapp/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('‚úÖ ' + data.message);
      } else {
        // Fallback to wa.me URL with formatted message
        console.log('WhatsApp API failed, trying fallback method...');
        return fallbackWhatsAppShare(guestId);
      }
    })
    .catch(error => {
      console.error('WhatsApp API Error:', error);
      // Fallback to wa.me URL
      return fallbackWhatsAppShare(guestId);
    })
    .finally(() => {
      // Restore button state
      btn.innerHTML = originalText;
      btn.disabled = false;
    });
  }
  
  function fallbackWhatsAppShare(guestId) {
    // Get formatted message from backend
    fetch(`/dashboard/guest-qr-codes/${guestId}/whatsapp-message/`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Open WhatsApp with formatted message
        const waUrl = `https://wa.me/${data.phone}?text=${encodeURIComponent(data.message)}`;
        window.open(waUrl, '_blank');
        alert('üì± WhatsApp opened with guest details. The QR code image needs to be shared separately.');
      } else {
        alert('‚ùå Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Fallback Error:', error);
      alert('‚ùå Failed to prepare WhatsApp message. Please try again.');
    });
  }
  
  function shareCurrentGuestQR() {
    if (currentGuestQRData.url) {
      const guestPhone = '{{ guest.phone|default:"" }}';
      shareGuestQR(currentGuestQRData.url, currentGuestQRData.guestName, guestPhone);
    }
  }
</script>
{% endblock dashboard_content %}
