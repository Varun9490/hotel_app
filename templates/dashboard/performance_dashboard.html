{% extends "dashboard/base_dashboard.html" %}
{% load static %}

{% block content %}
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="bg-gray-50 min-h-screen">
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="space-y-6">

      <header data-aos="fade-down" class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div>
            <h1 class="text-2xl font-bold text-gray-900">Performance Dashboard</h1>
            <p class="text-sm text-gray-600">Monitor staff performance, completion rates, and department metrics</p>
          </div>
          <div class="flex items-center gap-4 w-full md:w-auto">
            <div class="relative flex-grow">
              <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
              </span>
              <input autocomplete="off" type="search" placeholder="Search staff, departments..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-sky-500 focus:border-sky-500">
            </div>
          </div>
        </div>
      </header>

      <div data-aos="fade-down" data-aos-delay="100" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
          <div class="flex flex-wrap items-center gap-4">
            <select class="border-gray-300 rounded-lg">
              <option>All Departments</option>
              <option>Guest Services</option>
              <option>Housekeeping</option>
            </select>
            <div class="flex items-center gap-2">
              <input autocomplete="off" type="date" value="2024-01-15" class="border-gray-300 rounded-lg">
              <span class="text-gray-500">to</span>
              <input autocomplete="off" type="date" value="2024-01-22" class="border-gray-300 rounded-lg">
            </div>
          </div>
          <button class="w-full md:w-auto px-4 py-2 bg-sky-600 text-white font-medium rounded-lg hover:bg-sky-700 flex items-center justify-center gap-2">
            <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9.75v6.75m0 0l-3-3m3 3l3-3m-8.25 6a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.233-2.33 3 3 0 013.758 3.848A3.752 3.752 0 0118 19.5H6.75z" /></svg>
            Export
          </button>
        </div>
      </div>

      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div data-aos="fade-up" data-aos-delay="200" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-gray-600">Overall Completion Rate</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{{ completion_rate }}%</p>
            <p class="text-sm text-green-500 mt-2 flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.612L6.22 8.78a.75.75 0 11-1.06-1.06l4.25-4.25a.75.75 0 011.06 0l4.25 4.25a.75.75 0 11-1.06 1.06L10.75 5.612V16.25A.75.75 0 0110 17z" clip-rule="evenodd" /></svg>
              +3.2% vs last week
            </p>
          </div>
          <div class="bg-green-100 p-3 rounded-lg">
            <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
          </div>
        </div>
        <div data-aos="fade-up" data-aos-delay="300" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-gray-600">SLA Breaches</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{{ sla_breaches }}</p>
            <p class="text-sm text-red-500 mt-2 flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a.75.75 0 01.75.75v10.638l3.03-3.17a.75.75 0 111.06 1.06l-4.25 4.25a.75.75 0 01-1.06 0L5.22 11.28a.75.75 0 111.06-1.06l3.03 3.17V3.75A.75.75 0 0110 3z" clip-rule="evenodd" /></svg>
              +4 vs yesterday
            </p>
          </div>
          <div class="bg-red-100 p-3 rounded-lg">
             <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
          </div>
        </div>
        <div data-aos="fade-up" data-aos-delay="400" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-gray-600">Avg Response Time</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{{ avg_response_time }}m</p>
            <p class="text-sm text-green-500 mt-2 flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 17a.75.75 0 01-.75-.75V5.612L6.22 8.78a.75.75 0 11-1.06-1.06l4.25-4.25a.75.75 0 011.06 0l4.25 4.25a.75.75 0 11-1.06 1.06L10.75 5.612V16.25A.75.75 0 0110 17z" clip-rule="evenodd" /></svg>
              -2m vs last week
            </p>
          </div>
          <div class="bg-teal-100 p-3 rounded-lg">
             <svg class="h-6 w-6 text-teal-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </div>
        </div>
        <div data-aos="fade-up" data-aos-delay="500" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 flex justify-between items-start">
          <div>
            <p class="text-sm font-medium text-gray-600">Active Staff</p>
            <p class="text-3xl font-bold text-gray-900 mt-1">{{ active_staff }}</p>
            <p class="text-sm text-gray-500 mt-2 flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3.75a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 3.75zM5.25 5.25a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5zM15 6.75a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5a.75.75 0 01-.75.75zM6.75 15a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5zM13.25 15a.75.75 0 011.5 0v1.5a.75.75 0 01-1.5 0v-1.5zM10 15.75a.75.75 0 00-1.5 0v1.5a.75.75 0 001.5 0v-1.5zM3.75 10a.75.75 0 01.75-.75h1.5a.75.75 0 010 1.5h-1.5a.75.75 0 01-.75-.75zM13.25 10a.75.75 0 000 1.5h1.5a.75.75 0 000-1.5h-1.5z" /></svg>
              No change
            </p>
          </div>
          <div class="bg-sky-100 p-3 rounded-lg">
             <svg class="h-6 w-6 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          </div>
        </div>
      </section>

      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div data-aos="fade-up" data-aos-delay="300" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Completion Rates by Department</h3>
          <div class="h-80">
            <canvas id="completionRateChart"></canvas>
          </div>
        </div>
        <div data-aos="fade-up" data-aos-delay="400" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">SLA Breach Trends</h3>
          <div class="h-80">
            <canvas id="slaTrendChart"></canvas>
          </div>
        </div>
      </section>
      
      <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div data-aos="fade-up" data-aos-delay="500" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div class="flex justify-between items-center">
             <h3 class="text-lg font-semibold text-gray-900">Top Performers</h3>
             <span class="text-sm text-gray-500">This Week</span>
          </div>
          <div class="mt-4 space-y-3">
            {% for performer in top_performers %}
             <div class="{% if forloop.first %}bg-yellow-50 border border-yellow-200{% else %}bg-gray-50{% endif %} p-3 rounded-lg flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                   <span class="flex items-center justify-center w-8 h-8 rounded-full {% if forloop.first %}bg-yellow-400{% elif forloop.counter == 2 %}bg-gray-400{% elif forloop.counter == 3 %}bg-orange-400{% else %}bg-gray-300{% endif %} text-white font-bold">{{ forloop.counter }}</span>
                   <img class="w-10 h-10 rounded-full" src="https://placehold.co/40x40/{% if forloop.first %}FFC107{% elif forloop.counter == 2 %}9CA3AF{% elif forloop.counter == 3 %}F97316{% else %}6B7280{% endif %}/FFFFFF?text={{ performer.user.first_name|first }}{{ performer.user.last_name|first }}" alt="{{ performer.user.get_full_name }}">
                   <div>
                      <p class="font-medium text-gray-900">{{ performer.user.get_full_name }}</p>
                      <p class="text-sm text-gray-600">{{ performer.department.name|default:"Unassigned" }}</p>
                   </div>
                </div>
                <div class="text-right">
                   <p class="font-bold text-green-500">{{ performer.completion_rate }}%</p>
                   <p class="text-sm text-gray-500">{{ performer.tickets_completed }} tickets</p>
                </div>
             </div>
            {% empty %}
             <div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                   <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-400 text-white font-bold">-</span>
                   <div>
                      <p class="font-medium text-gray-900">No data available</p>
                      <p class="text-sm text-gray-600">-</p>
                   </div>
                </div>
                <div class="text-right">
                   <p class="font-bold text-gray-500">-</p>
                   <p class="text-sm text-gray-500">-</p>
                </div>
             </div>
            {% endfor %}
          </div>
        </div>
        <div data-aos="fade-up" data-aos-delay="600" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
          <div class="flex justify-between items-center">
             <h3 class="text-lg font-semibold text-gray-900">Department Rankings</h3>
             <span class="text-sm text-gray-500">This Week</span>
          </div>
           <div class="mt-4 space-y-3">
            {% for ranking in department_rankings %}
             <div class="{% if forloop.first %}bg-green-50 border border-green-200{% else %}bg-gray-50{% endif %} p-3 rounded-lg flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                   <span class="flex items-center justify-center w-8 h-8 rounded-full {% if forloop.first %}bg-green-500{% elif forloop.counter == 2 %}bg-gray-400{% elif forloop.counter == 3 %}bg-orange-400{% else %}bg-gray-300{% endif %} text-white font-bold">{{ forloop.counter }}</span>
                   <div class="w-10 h-10 {% if forloop.first %}bg-blue-100{% elif forloop.counter == 2 %}bg-purple-100{% elif forloop.counter == 3 %}bg-orange-100{% else %}bg-gray-100{% endif %} rounded-lg flex items-center justify-center"></div>
                   <div>
                      <p class="font-medium text-gray-900">{{ ranking.department.name }}</p>
                      <p class="text-sm text-gray-600">{{ ranking.staff_count }} staff members</p>
                   </div>
                </div>
                <div class="text-right">
                   <p class="font-bold {% if ranking.completion_rate >= 90 %}text-green-500{% elif ranking.completion_rate >= 80 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ ranking.completion_rate }}%</p>
                   <p class="text-sm text-gray-500">{{ ranking.tickets_handled }} tickets</p>
                </div>
             </div>
            {% empty %}
             <div class="bg-gray-50 p-3 rounded-lg flex items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                   <span class="flex items-center justify-center w-8 h-8 rounded-full bg-gray-400 text-white font-bold">-</span>
                   <div>
                      <p class="font-medium text-gray-900">No data available</p>
                      <p class="text-sm text-gray-600">-</p>
                   </div>
                </div>
                <div class="text-right">
                   <p class="font-bold text-gray-500">-</p>
                   <p class="text-sm text-gray-500">-</p>
                </div>
             </div>
            {% endfor %}
          </div>
        </div>
      </section>

      <section data-aos="fade-up" data-aos-delay="700" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">Staff Performance Details</h3>
            <div class="flex items-center gap-4">
                <a href="#" class="text-sm font-medium text-gray-600 hover:text-sky-600 flex items-center gap-1">Filter</a>
                <a href="#" class="text-sm font-medium text-sky-600 hover:text-sky-800">View All</a>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-600 font-medium">
                    <tr>
                        <th class="p-4">Staff Member</th>
                        <th class="p-4">Department</th>
                        <th class="p-4 text-center">Tickets Completed</th>
                        <th class="p-4 text-center">Completion Rate</th>
                        <th class="p-4 text-center">Avg. Response</th>
                        <th class="p-4 text-center">Breaches</th>
                        <th class="p-4 text-center">Status</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for staff in staff_performance %}
                    <tr>
                        <td class="p-4 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <img class="w-8 h-8 rounded-full" src="https://placehold.co/32x32/6B7280/FFFFFF?text={{ staff.user.first_name|first }}{{ staff.user.last_name|first }}" alt="{{ staff.user.get_full_name }}">
                                <span class="font-medium text-gray-900">{{ staff.user.get_full_name }}</span>
                            </div>
                        </td>
                        <td class="p-4 whitespace-nowrap text-gray-600">{{ staff.department.name|default:"Unassigned" }}</td>
                        <td class="p-4 whitespace-nowrap text-center font-medium">{{ staff.tickets_completed }}</td>
                        <td class="p-4 whitespace-nowrap text-center font-medium {% if staff.completion_rate >= 90 %}text-green-500{% elif staff.completion_rate >= 80 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ staff.completion_rate }}%</td>
                        <td class="p-4 whitespace-nowrap text-center text-gray-600">{{ staff.avg_response }}m</td>
                        <td class="p-4 whitespace-nowrap text-center font-medium {% if staff.breaches == 0 %}text-green-500{% elif staff.breaches <= 2 %}text-yellow-500{% else %}text-red-500{% endif %}">{{ staff.breaches }}</td>
                        <td class="p-4 whitespace-nowrap text-center">
                            <span class="px-2 py-1 text-xs font-medium {{ staff.status_class }} rounded-full">{{ staff.status }}</span>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-500">No staff performance data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
      </section>

    </div>
  </main>
</div>

<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 3. Initialize AOS
    AOS.init({
      duration: 800, // values from 0 to 3000, with step 50ms
      once: true, // whether animation should happen only once - while scrolling down
    });

    // === Bar Chart: Completion Rates by Department ===
    const completionRateCtx = document.getElementById('completionRateChart').getContext('2d');
    const completionRateChart = new Chart(completionRateCtx, {
      type: 'bar',
      data: {
        labels: {{ department_labels|safe }},
        datasets: [{
          label: 'Completion Rate',
          data: {{ department_completion_data }},
          backgroundColor: '#0284c7',
          borderColor: '#0369a1',
          borderWidth: 1,
          borderRadius: 4,
          barPercentage: 0.6,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return ` ${context.dataset.label}: ${context.raw}%`;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: {
              color: '#e5e7eb'
            },
            ticks: {
              color: '#6b7280',
              callback: function(value) {
                return value + '%';
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
               color: '#6b7280'
            }
          }
        }
      }
    });

    // === Line Chart: SLA Breach Trends ===
    const slaTrendCtx = document.getElementById('slaTrendChart').getContext('2d');
    const slaTrendChart = new Chart(slaTrendCtx, {
      type: 'line',
      data: {
        labels: {{ sla_breach_labels|safe }},
        datasets: [{
          label: 'SLA Breaches',
          data: {{ sla_breach_trends }},
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.4,
          fill: true,
          pointBackgroundColor: '#ef4444',
          pointBorderColor: '#fff',
          pointHoverRadius: 6,
          pointRadius: 4,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: '#e5e7eb'
            },
            ticks: {
              color: '#6b7280',
              stepSize: 1
            }
          },
          x: {
            grid: {
              display: false
            },
             ticks: {
               color: '#6b7280'
            }
          }
        }
      }
    });
  });
</script>

{% endblock content %}