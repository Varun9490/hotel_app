{% extends "dashboard/base_dashboard.html" %}
{% load static %}
{% load dashboard2_extras %}

{% block extra_css %}
<style>
    /* Custom CSS for animations and smooth scrolling */
    html {
        scroll-behavior: smooth;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-in-up {
        opacity: 0; /* Start hidden */
        animation: slideInUp 0.6s ease-out forwards;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="w-full max-w-7xl mx-auto bg-gray-50 font-['Inter']">

    <div class="w-full h-16 bg-white border-b border-gray-200 flex items-center px-4 sm:px-6">
        <div class="w-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-gray-900 text-2xl font-bold">My Tickets</h1>
                <div class="hidden sm:flex items-center gap-2">
                    <span class="px-3 py-1 bg-blue-100 text-sky-600 text-xs font-medium rounded-full">
                        {{ page_obj.paginator.count|default:0 }} Active
                    </span>
                    {# Note: You must pass 'overdue_count' from your view for this to be dynamic #}
                    <span class="px-3 py-1 bg-yellow-100 text-yellow-400 text-xs font-medium rounded-full">
                        {{ overdue_count|default:0 }} Overdue
                    </span>
                </div>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-4">
                <a href="#" class="hidden sm:flex items-center justify-center gap-2 h-9 px-4 bg-sky-600 hover:bg-sky-700 text-white text-sm font-medium rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                    New Ticket
                </a>
            </div>
        </div>
    </div>

    <div class="w-full bg-white border-b border-gray-200 px-4 sm:px-6 py-3">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <form autocomplete="off" id="filterForm" method="get" class="flex flex-wrap items-center gap-3 w-full sm:w-auto">
                <input autocomplete="off" type="hidden" name="search" value="{{ search_query|default:'' }}">
                
                <select name="priority" onchange="this.form.submit()" class="w-full sm:w-auto flex-grow h-9 rounded-lg border border-gray-300 bg-gray-50 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 cursor-pointer">
                    <option value="">All Priorities</option>
                    <option value="High" {% if priority_filter == 'High' %}selected{% endif %}>High</option>
                    <option value="Medium" {% if priority_filter == 'Medium' %}selected{% endif %}>Medium</option>
                    <option value="Low" {% if priority_filter == 'Low' %}selected{% endif %}>Low</option>
                </select>
                
                <select name="status" onchange="this.form.submit()" class="w-full sm:w-auto flex-grow h-9 rounded-lg border border-gray-300 bg-gray-50 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 cursor-pointer">
                    <option value="">All Statuses</option>
                    <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Accepted" {% if status_filter == 'Accepted' %}selected{% endif %}>Accepted</option>
                    <option value="In Progress" {% if status_filter == 'In Progress' %}selected{% endif %}>In Progress</option>
                    <option value="Completed" {% if status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                    <option value="Closed" {% if status_filter == 'Closed' %}selected{% endif %}>Closed</option>
                </select>
            </form>

            <div class="flex w-full sm:w-auto items-center gap-3">
                <form autocomplete="off" id="searchForm" method="get" class="relative flex-grow">
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input autocomplete="off" type="text" name="search" placeholder="Search tasks..." value="{{ search_query|default:'' }}" class="w-full h-9 pl-10 pr-4 bg-gray-50 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                    {% if priority_filter %}<input autocomplete="off" type="hidden" name="priority" value="{{ priority_filter }}">{% endif %}
                    {% if status_filter %}<input autocomplete="off" type="hidden" name="status" value="{{ status_filter }}">{% endif %}
                </form>
                </div>
        </div>
    </div>

    <div class="p-4 sm:p-6">
        {# Note: You must pass 'status_counts' dictionary from your view with keys like 'pending', 'accepted', etc. #}
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 0ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.pending|default:0 }}</div>
                    <div class="text-sm text-gray-600">Pending</div>
                </div>
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex justify-center items-center">
                    <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 100ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.accepted|default:0 }}</div>
                    <div class="text-sm text-gray-600">Accepted</div>
                </div>
                <div class="w-10 h-10 bg-sky-100 rounded-lg flex justify-center items-center">
                    <svg class="w-5 h-5 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 200ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.in_progress|default:0 }}</div>
                    <div class="text-sm text-gray-600">In Progress</div>
                </div>
                <div class="w-10 h-10 bg-sky-100 rounded-lg flex justify-center items-center">
                     <svg class="w-5 h-5 text-sky-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5"></path></svg>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex justify-between items-center animate-slide-in-up" style="animation-delay: 300ms;">
                <div>
                    <div class="text-2xl font-bold text-gray-900">{{ status_counts.completed|default:0 }}</div>
                    <div class="text-sm text-gray-600">Completed</div>
                </div>
                <div class="w-10 h-10 bg-green-100 rounded-lg flex justify-center items-center">
                    <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
            </div>
        </div>

        <div class="hidden md:block bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="grid" style="grid-template-columns: 3fr 1.5fr 1.5fr 1fr 1.5fr 1.5fr;">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Task</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Priority</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Room/Location</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Status</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Due Date</div>
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 text-left text-sm font-semibold text-gray-700">Actions</div>
            </div>
            <div>
                {% for ticket in tickets %}
                <div class="grid items-center hover:bg-gray-50" style="grid-template-columns: 3fr 1.5fr 1.5fr 1fr 1.5fr 1.5fr;">
                    <div class="px-6 py-4 border-b border-gray-100">
                        <p class="text-base font-medium text-gray-900">{{ ticket.request_type.name }}</p>
                        <p class="text-sm text-gray-500 truncate">{{ ticket.notes|truncatewords:10 }}</p>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <span class="px-3 py-1 inline-flex text-xs font-medium rounded-full 
                            {% if ticket.priority_label == 'High' %}bg-red-100 text-red-600
                            {% elif ticket.priority_label == 'Medium' %}bg-yellow-100 text-yellow-600
                            {% else %}bg-green-100 text-green-600{% endif %}">
                            {{ ticket.priority_label }}
                        </span>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <p class="text-sm font-medium text-black">{{ ticket.location }}</p>
                        <p class="text-sm text-gray-500">{{ ticket.location.floor|default:'N/A' }}</p>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <span class="px-2 py-1 inline-flex text-xs font-medium rounded-full 
                            {% if ticket.status == 'pending' %}bg-yellow-100 text-yellow-500
                            {% elif ticket.status == 'in_progress' %}bg-blue-100 text-sky-600
                            {% elif ticket.status == 'accepted' %}bg-blue-100 text-sky-600
                            {% else %}bg-green-100 text-green-700{% endif %}">
                            {{ ticket.get_status_display }}
                        </span>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <p class="text-sm font-medium {% if ticket.sla_breached %}text-red-500{% else %}text-black{% endif %}">
                            {{ ticket.get_time_left }}
                        </p>
                        <p class="text-sm text-gray-500">
                           {% if ticket.sla_breached %}Overdue{% else %}On Time{% endif %}
                        </p>
                    </div>
                    <div class="px-6 py-4 border-b border-gray-100">
                        <div class="flex items-center gap-2">
                            {% if ticket.can_accept %}
                                <button class="accept-ticket-btn text-xs font-medium text-white bg-sky-600 hover:bg-sky-700 rounded px-3 py-1.5" data-ticket-id="{{ ticket.id }}">Accept</button>
                            {% elif ticket.can_start %}
                                <button class="start-ticket-btn text-xs font-medium text-white bg-sky-600 hover:bg-sky-700 rounded px-3 py-1.5" data-ticket-id="{{ ticket.id }}">Start</button>
                            {% elif ticket.can_complete %}
                                <button class="complete-ticket-btn text-xs font-medium text-white bg-green-500 hover:bg-green-600 rounded px-3 py-1.5" data-ticket-id="{{ ticket.id }}">Complete</button>
                            {% endif %}
                            <a href="{% url 'dashboard:ticket_detail' ticket.id %}" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100" title="View Details">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </a>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-12 text-gray-500">No tasks found.</div>
                {% endfor %}
            </div>
        </div>

        <div class="block md:hidden space-y-4">
            {% for ticket in tickets %}
            <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm">
                <div class="flex justify-between items-start gap-4">
                    <div>
                        <p class="text-base font-medium text-gray-900">{{ ticket.request_type.name }}</p>
                        <p class="text-sm text-gray-600">{{ ticket.location }} • {{ ticket.location.floor|default:'N/A' }}</p>
                    </div>
                    <span class="px-3 py-1 inline-flex text-xs font-medium rounded-full 
                        {% if ticket.priority_label == 'High' %}bg-red-100 text-red-600
                        {% elif ticket.priority_label == 'Medium' %}bg-yellow-100 text-yellow-600
                        {% else %}bg-green-100 text-green-600{% endif %}">
                        {{ ticket.priority_label }}
                    </span>
                </div>

                <div class="flex items-center gap-4 my-3 text-xs">
                    <span class="px-2 py-1 font-normal rounded-full 
                        {% if ticket.status == 'pending' %}bg-yellow-100 text-yellow-500
                        {% elif ticket.status == 'in_progress' %}bg-blue-100 text-sky-600
                        {% elif ticket.status == 'accepted' %}bg-blue-100 text-sky-600
                        {% else %}bg-green-100 text-green-700{% endif %}">
                        {{ ticket.get_status_display }}
                    </span>
                    <span class="text-neutral-500">Due: {{ ticket.get_time_left }}</span>
                </div>

                <div class="my-4">
                    <div class="flex justify-between items-center text-xs text-gray-600 mb-1">
                        <span>SLA Progress</span>
                        <span class="font-medium {% if ticket.sla_breached %}text-red-500{% else %}text-gray-600{% endif %}">
                            {{ ticket.sla_progress_percent|default:0 }}%
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="h-1.5 rounded-full 
                            {% if ticket.sla_breached %}bg-red-500
                            {% else %}bg-yellow-400{% endif %}" style="width: {{ ticket.sla_progress_percent|default:0 }}%"></div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    {% if ticket.can_accept %}
                        <button class="accept-ticket-btn flex-grow text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg h-10 flex items-center justify-center" data-ticket-id="{{ ticket.id }}">Accept</button>
                    {% elif ticket.can_start %}
                        <button class="start-ticket-btn flex-grow text-sm font-medium text-white bg-sky-600 hover:bg-sky-700 rounded-lg h-10 flex items-center justify-center" data-ticket-id="{{ ticket.id }}">Start Task</button>
                    {% elif ticket.can_complete %}
                        <button class="complete-ticket-btn flex-grow text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg h-10 flex items-center justify-center" data-ticket-id="{{ ticket.id }}">Complete</button>
                    {% endif %}
                    <a href="{% url 'dashboard:ticket_detail' ticket.id %}" class="h-10 w-10 flex-shrink-0 flex items-center justify-center rounded-lg border border-gray-200 text-gray-600 hover:bg-gray-50" title="View Details">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-12">
                <p class="text-gray-500">No tickets found.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Resolution Notes Modal -->
<div id="resolutionNotesModal" class="fixed inset-0 z-[1000] hidden items-center justify-center p-4 backdrop-blur-sm bg-black bg-opacity-30 transition-opacity duration-300 opacity-0" onclick="closeResolutionNotesModal()">
    <div class="w-full max-w-md rounded-lg bg-white shadow-xl transform transition-all duration-300 scale-95 opacity-0" onclick="event.stopPropagation()">
        <div class="p-6">
            <div class="flex items-start justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Resolution Notes</h3>
                <button type="button" onclick="closeResolutionNotesModal()" class="rounded-full p-1 text-gray-500 hover:bg-gray-100 transition-colors" aria-label="Close">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="mt-4">
                <label for="resolutionNotesInput" class="block text-sm font-medium text-gray-700 mb-2">Please enter resolution notes:</label>
                <textarea id="resolutionNotesInput" rows="4" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Describe how this ticket was resolved..."></textarea>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" onclick="closeResolutionNotesModal()" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-50">Cancel</button>
                <button type="button" id="submitResolutionNotes" class="rounded-md bg-sky-600 px-4 py-2 text-sm font-medium text-white hover:bg-sky-700">Submit</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function handleTicketAction(button, url, options = {}) {
        const ticketId = button.getAttribute('data-ticket-id');
        let confirmationMessage = options.confirmationMessage || 'Are you sure?';
        
        let body = {};
        if (options.requiresNotes) {
            // Show resolution notes modal instead of using prompt
            showResolutionNotesModal(url.replace('TICKET_ID', ticketId), options);
            return;
        }

        // Use custom confirmation modal instead of browser confirm
        if (!options.requiresNotes) {
            showConfirmationModal('Confirm Action', confirmationMessage, function() {
                performTicketAction(ticketId, url, body, options);
            });
            return;
        }

        // For actions that require notes, proceed directly
        performTicketAction(ticketId, url, body, options);
    }

    function performTicketAction(ticketId, url, body, options) {
        fetch(url.replace('TICKET_ID', ticketId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: Object.keys(body).length > 0 ? JSON.stringify(body) : null
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Use toast notification instead of alert
                showToast(options.successMessage || 'Action successful!', 'success');
                location.reload();
            } else {
                // Use toast notification for errors
                showToast('Error: ' + (data.error || 'An unknown error occurred.'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Use toast notification for errors
            showToast('An error occurred. Please try again.', 'error');
        });
    }

    // Function to show resolution notes modal
    function showResolutionNotesModal(url, options) {
        const modal = document.getElementById('resolutionNotesModal');
        const textarea = document.getElementById('resolutionNotesInput');
        const submitButton = document.getElementById('submitResolutionNotes');
        
        if (!modal || !textarea || !submitButton) return;
        
        // Clear previous content
        textarea.value = '';
        
        // Set up submit action
        submitButton.onclick = function() {
            const notes = textarea.value.trim();
            if (!notes) {
                showToast('Please enter resolution notes.', 'error');
                return;
            }
            
            const body = {};
            body[options.notesField] = notes;
            
            closeResolutionNotesModal();
            performTicketAction(null, url, body, options);
        };
        
        // Show modal with animation
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        requestAnimationFrame(() => {
            modal.classList.remove('opacity-0');
            const dialog = modal.querySelector('div[onclick="event.stopPropagation()"]');
            if (dialog) {
                dialog.classList.remove('scale-95', 'opacity-0');
                dialog.classList.add('scale-100', 'opacity-100');
            }
        });
        
        // Focus the textarea
        setTimeout(() => textarea.focus(), 300);
    }
    
    // Function to close resolution notes modal
    function closeResolutionNotesModal() {
        const modal = document.getElementById('resolutionNotesModal');
        if (!modal) return;
        
        const dialog = modal.querySelector('div[onclick="event.stopPropagation()"]');
        modal.classList.add('opacity-0');
        if (dialog) {
            dialog.classList.remove('scale-100', 'opacity-100');
            dialog.classList.add('scale-95', 'opacity-0');
        }
        
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }, 300);
    }

    document.body.addEventListener('click', function(event) {
        const button = event.target.closest('button');
        if (!button) return;

        if (button.classList.contains('accept-ticket-btn')) {
            handleTicketAction(button, '/dashboard/api/tickets/TICKET_ID/accept/', {
                confirmationMessage: 'Are you sure you want to accept this ticket?',
                successMessage: 'Ticket accepted successfully!'
            });
        }
        else if (button.classList.contains('start-ticket-btn')) {
            handleTicketAction(button, '/dashboard/api/tickets/TICKET_ID/start/', {
                confirmationMessage: 'Are you sure you want to start working on this ticket?',
                successMessage: 'Work started on ticket successfully!'
            });
        }
        else if (button.classList.contains('complete-ticket-btn')) {
            handleTicketAction(button, '/dashboard/api/tickets/TICKET_ID/complete/', {
                requiresNotes: true,
                notesPrompt: 'Please enter resolution notes:',
                notesField: 'resolution_notes',
                successMessage: 'Ticket marked as completed successfully!'
            });
        }
    });
});
</script>
{% endblock extra_js %}