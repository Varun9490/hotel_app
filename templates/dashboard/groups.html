{% extends "dashboard/manage_users_base.html" %}
{% load static %}
{% block manage_content %}
<div class="w-[1184px] min-h-screen bg-black/0 border-gray-200 mx-auto">

  <!-- Top Stats Cards -->
  <div class="px-6 pt-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

      <!-- Total Groups -->
      <div class="bg-white rounded-xl shadow-[0px_1px_2px_0px_rgba(0,0,0,0.05)] outline outline-1 outline-offset-[-1px] outline-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div class="w-8 h-10 bg-sky-600/10 rounded-lg flex items-center justify-center">
            <img src="{% static 'images/manage_users/total_groups.svg' %}" alt="Total Groups" class="w-4 h-4" />
          </div>
          <div class="text-green-500 text-xs font-medium font-['Inter']">+2</div>
        </div>
        <div class="mt-6">
          <div class="text-gray-900 text-2xl font-bold font-['Inter']">{{ total_groups }}</div>
          <div class="text-gray-600 text-sm font-normal font-['Inter'] mt-1">Total Groups</div>
        </div>
      </div>

      <!-- Members Assigned -->
      <div class="bg-white rounded-xl shadow-[0px_1px_2px_0px_rgba(0,0,0,0.05)] outline outline-1 outline-offset-[-1px] outline-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div class="w-9 h-10 bg-teal-500/10 rounded-lg flex items-center justify-center">
            <img src="{% static 'images/manage_users/members_assigned.svg' %}" alt="Members Assigned" class="w-5 h-4" />
          </div>
          <div class="text-green-500 text-xs font-medium font-['Inter']">+12</div>
        </div>
        <div class="mt-6">
          <div class="text-gray-900 text-2xl font-bold font-['Inter']">{{ total_group_members }}</div>
          <div class="text-gray-600 text-sm font-normal font-['Inter'] mt-1">Members Assigned</div>
        </div>
      </div>

      <!-- Recent Additions -->
      <div class="bg-white rounded-xl shadow-[0px_1px_2px_0px_rgba(0,0,0,0.05)] outline outline-1 outline-offset-[-1px] outline-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div class="w-9 h-10 bg-yellow-400/10 rounded-lg flex items-center justify-center">
            <img src="{% static 'images/manage_users/recent_additions.svg' %}" alt="Recent Additions" class="w-5 h-4" />
          </div>
          <div class="text-gray-600 text-xs font-normal font-['Inter']">24h</div>
        </div>
        <div class="mt-6">
          <div class="text-gray-900 text-2xl font-bold font-['Inter']">{{ recent_additions }}</div>
          <div class="text-gray-600 text-sm font-normal font-['Inter'] mt-1">Recent Additions</div>
        </div>
      </div>

      <!-- Active Groups / Bulk Notifications -->
      <div class="bg-white rounded-xl shadow-[0px_1px_2px_0px_rgba(0,0,0,0.05)] outline outline-1 outline-offset-[-1px] outline-gray-200 p-6">
        <div class="flex items-center justify-between">
          <div class="w-7 h-10 bg-fuchsia-700/10 rounded-lg flex items-center justify-center">
            <img src="{% static 'images/manage_users/bulk_notifications.svg' %}" alt="Bulk Notifications" class="w-3.5 h-4" />
          </div>
          <div class="text-sky-600 text-xs font-medium font-['Inter']">Active</div>
        </div>
        <div class="mt-6">
          <div class="text-gray-900 text-2xl font-bold font-['Inter']">{{ active_groups }}</div>
          <div class="text-gray-600 text-sm font-normal font-['Inter'] mt-1">Bulk Notifications</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Department Groups Panel -->
  <div class="w-[1136px] bg-white rounded-xl shadow-[0px_1px_2px_0px_rgba(0,0,0,0.05)] outline outline-1 outline-offset-[-1px] outline-gray-200 mx-6 mt-6">
    <!-- Panel Header -->
    <div class="border-b border-gray-200 px-6 py-5">
      <div class="flex items-center justify-between">
        <div class="text-gray-900 text-lg font-semibold font-['Inter']">Department Groups</div>
        <div class="flex items-center gap-3">
          <button type="button" class="w-20 h-8 bg-white rounded-lg border border-gray-200 flex items-center justify-center gap-2 px-3">
            <span class="w-3.5 h-2.5 ">
              <img src="{% static 'images/manage_users/filter.svg' %}" alt="Filter"  />
            </span>
            <span class="text-gray-600 text-sm font-normal font-['Inter']">Filter</span>
          </button>
          <button type="button" class="w-36 h-8 bg-white rounded-lg border border-gray-200 flex items-center justify-center gap-2 px-3">
            <span class="w-3.5 h-2.5 ">
              <img src="{% static 'images/manage_users/notify.svg' %}" alt="Notify" />
            </span>
            <span class="text-sky-600 text-sm font-normal font-['Inter']">Bulk Notify All</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Department Groups List (Accordion) -->
    <div class="px-6 py-6 space-y-6" id="departments-accordion">
      {% for dept in departments %}
  <div class="department-group w-full bg-black/0 rounded-lg outline outline-1 outline-offset-[-1px] outline-gray-200 p-4" id="department-group-{{ forloop.counter0 }}" data-dept-id="{{ dept.featured_group.id }}">
        <div class="flex items-start justify-between gap-4">
          <div class="flex items-start gap-4">
            <div class="w-11 h-12 {{ dept.featured_group.icon_bg|default:'bg-green-500/10' }} rounded-lg flex items-center justify-center overflow-hidden">
              <!-- Department icon loaded by name mapping -->
              <img
                class="h-6 w-6 dept-icon"
                data-icon-name="{{ dept.featured_group.name|default:'Housekeeping' }}"
                alt="{{ dept.featured_group.name|default:'Housekeeping' }} icon"
                src="{% static 'images/manage_users/housekeeping.svg' %}"
              />
            </div>
            <div class="min-w-0">
              <div class="flex items-center gap-2">
                <div class="text-gray-900 text-lg font-semibold font-['Inter'] truncate">
                  {{ dept.featured_group.name|default:"Housekeeping" }}
                </div>
                <div class="{{ dept.featured_group.tag_bg|default:'bg-green-500/10' }} rounded-full">
                  <div class="px-2 py-1">
                    <span class="text-{{ dept.featured_group.icon_color|default:'green-500' }} text-xs font-medium font-['Inter']">
                      <span class="dept-members-count">{{ dept.featured_group.members_count|default:"42" }}</span> members
                    </span>
                  </div>
                </div>
              </div>
              <div class="text-gray-600 text-sm font-normal font-['Inter'] mt-1">
                {{ dept.featured_group.description|default:"Room cleaning, maintenance, and guest services" }}
              </div>
              <div class="flex items-center gap-4 text-neutral-500 text-xs font-normal font-['Inter'] mt-2">
                <div>Supervisors: <span class="dept-supervisors-count">{{ dept.featured_group.supervisors_count|default:"6" }}</span></div>
                <div>Staff: <span class="dept-staff-count">{{ dept.featured_group.staff_count|default:"36" }}</span></div>
                <div>Last updated: <span class="dept-updated-at">{{ dept.featured_group.updated_at|default:"2h ago" }}</span></div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2 shrink-0">
            <button type="button" class="w-32 h-8 bg-white rounded-lg border border-gray-200 flex items-center justify-center gap-2 dept-notify-btn" data-dept-id="{{ dept.featured_group.id }}">
              <span class="w-3.5 h-2.5 ">
                <img src="{% static 'images/manage_users/notify.svg' %}" alt="Notify"  />
              </span>
              <span class="text-sky-600 text-sm font-normal font-['Inter']">Notify Group</span>
            </button>

            <!-- Accordion Toggle Button (no border, closed by default) -->
            <button
              type="button"
              class="w-8 h-8 rounded-lg flex items-center justify-center dept-accordion-toggle bg-transparent hover:bg-gray-50 border-none focus:outline-none"
              aria-expanded="false"
              aria-controls="dept-content-{{ forloop.counter0 }}"
              data-target="dept-content-{{ forloop.counter0 }}"
              title="Toggle details"
            >
              <!-- Open (expand) icon shown when collapsed -->
              <img src="{% static 'images/manage_users/open.svg' %}" alt="Open" class="h-4 w-4 open-icon" />
              <!-- Close (collapse) icon shown when expanded -->
              <img src="{% static 'images/manage_users/close.svg' %}" alt="Close" class="h-4 w-4 close-icon hidden" />
            </button>
          </div>
        </div>

        <!-- Accordion Content: hidden by default -->
        <div id="dept-content-{{ forloop.counter0 }}" class="mt-4 space-y-3 dept-accordion-content hidden">
          {% for group in dept.groups|slice:":3" %}
          <div class="group-item w-full p-3 bg-neutral-50 rounded-lg flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-2 h-2 {{ group.dot_bg|default:'bg-green-500' }} rounded-full"></div>
              <div class="text-gray-900 text-sm font-medium font-['Inter']">{{ group.name }}</div>
              <div class="text-neutral-500 text-xs font-normal font-['Inter']">({{ group.members_count|default:"0" }} members)</div>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" class="text-sky-600 text-xs font-normal font-['Inter']" onclick="openGroupMembersModal({{ group.pk|default:0 }}, '{{ group.name|escapejs }}')">Add Users</button>
              <button type="button" class="text-gray-600 text-xs font-normal font-['Inter']" onclick="openGroupEdit({{ group.pk|default:0 }}, '{{ group.name|escapejs }}')">Edit</button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endblock manage_content %}

{% block extra_js %}{{ block.super }}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Static base path for icons
    const BASE = "{% static 'images/manage_users/' %}";

    // Explicit mapping as requested:
    // housekeeping -> housekeeping.svg
    // front office -> front_office.svg
    // food & beverage -> food_beverage.svg
    // maintainence -> maintainence.svg
    // security -> security.svg
    // Also handle common variants: "food & beverages", "food and beverage(s)", "maintenance"
    const ICON_MAP = {
      'housekeeping': 'housekeeping.svg',
      'front office': 'front_office.svg',
      'food & beverage': 'food_beverage.svg',
      'food & beverages': 'food_beverage.svg',
      'food and beverage': 'food_beverage.svg',
      'food and beverages': 'food_beverage.svg',
      'maintainence': 'maintainence.svg',
      'maintenance': 'maintainence.svg',
      'security': 'security.svg'
    };

    function normalizeName(name) {
      return (name || '').toLowerCase().trim().replace(/\s+/g, ' ');
    }

    // Assign icons without infinite reloads; safe fallback
    document.querySelectorAll('.dept-icon').forEach(function (img) {
      const raw = img.getAttribute('data-icon-name') || '';
      const key = normalizeName(raw);
      const file = ICON_MAP[key] || 'housekeeping.svg'; // fallback
      // prevent infinite error loop if fallback also 404s
      img.onerror = function () {
        this.onerror = null;
        this.src = BASE + 'housekeeping.svg';
      };
      img.src = BASE + file;
    });

    // Accordion behavior: all closed by default, toggle without borders
    const toggles = document.querySelectorAll('.dept-accordion-toggle');

    function collapse(btn) {
      const targetId = btn.getAttribute('data-target');
      const content = document.getElementById(targetId);
      if (!content) return;
      btn.setAttribute('aria-expanded', 'false');
      content.classList.add('hidden');
      const openIcon = btn.querySelector('.open-icon');
      const closeIcon = btn.querySelector('.close-icon');
      if (openIcon) openIcon.classList.remove('hidden');
      if (closeIcon) closeIcon.classList.add('hidden');
    }

    function expand(btn) {
      const targetId = btn.getAttribute('data-target');
      const content = document.getElementById(targetId);
      if (!content) return;
      btn.setAttribute('aria-expanded', 'true');
      content.classList.remove('hidden');
      const openIcon = btn.querySelector('.open-icon');
      const closeIcon = btn.querySelector('.close-icon');
      if (openIcon) openIcon.classList.add('hidden');
      if (closeIcon) closeIcon.classList.remove('hidden');
    }

    // Initialize: collapsed
    toggles.forEach(function (btn) {
      btn.setAttribute('aria-expanded', 'false');
      const targetId = btn.getAttribute('data-target');
      const content = document.getElementById(targetId);
      if (content && !content.classList.contains('hidden')) {
        content.classList.add('hidden');
      }
      const openIcon = btn.querySelector('.open-icon');
      const closeIcon = btn.querySelector('.close-icon');
      if (openIcon) openIcon.classList.remove('hidden');
      if (closeIcon) closeIcon.classList.add('hidden');

      btn.addEventListener('click', function () {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
          collapse(this);
        } else {
          expand(this);
        }
      });
    });

    // --- Dynamic data & notify wiring ---
    const csrftoken = (function getCSRF(){
      const el = document.querySelector('input[name=csrfmiddlewaretoken]');
      if(el) return el.value;
      const cookieMatch = document.cookie.match(/csrftoken=([^;]+)/);
      return cookieMatch ? cookieMatch[1] : '';
    })();

    function apiFetch(url, opts) {
      opts = opts || {};
      opts.headers = opts.headers || {};
      if (opts.method && opts.method.toUpperCase() !== 'GET') {
        opts.headers['X-CSRFToken'] = csrftoken;
      }
      opts.headers['Accept'] = 'application/json';
      return fetch(url, opts).then(r => r.json());
    }

    // Fetch department members counts and update counts in-place
    document.querySelectorAll('.department-group[data-dept-id]').forEach(async function(el){
      const deptId = el.getAttribute('data-dept-id');
      if(!deptId) return;
      try{
        const resp = await apiFetch(`/dashboard/api/departments/${deptId}/members/`);
        if(resp && resp.members){
          const members = resp.members;
          const membersCountEl = el.querySelector('.dept-members-count');
          const supervisorsEl = el.querySelector('.dept-supervisors-count');
          const staffEl = el.querySelector('.dept-staff-count');
          const updatedEl = el.querySelector('.dept-updated-at');

          if(membersCountEl) membersCountEl.textContent = members.length;

          // rudimentary supervisor/staff split based on title available via extra API is not implemented here;
          // try to compute using email/phone heuristics (best-effort) and keep staff as members - supervisors
          if(supervisorsEl) supervisorsEl.textContent = members.filter(m=>/supervisor|manager/i.test(m.full_name||'')).length || '0';
          if(staffEl) staffEl.textContent = Math.max(0, members.length - (parseInt(supervisorsEl.textContent) || 0));
          if(updatedEl) updatedEl.textContent = 'just now';
        }
      }catch(e){
        // ignore errors - keep server-side values
      }
    });

    // Bulk Notify All button (top panel)
    const bulkBtn = document.querySelector('button:has(.text-sky-600[textContent="Bulk Notify All"])');
    // If :has not supported, fallback to selecting by text in multiple buttons
    function findBulkNotify(){
      const buttons = Array.from(document.querySelectorAll('button'));
      return buttons.find(b=>b.textContent && b.textContent.trim().includes('Bulk Notify All'));
    }
    const bulkNotifyBtn = bulkBtn || findBulkNotify();
    if(bulkNotifyBtn){
      bulkNotifyBtn.addEventListener('click', async function(){
        const message = prompt('Enter bulk notification message (leave blank for default):');
        try{
          const body = JSON.stringify({message: message});
          const resp = await apiFetch('/dashboard/api/groups/notify-all/', {method: 'POST', body: body, headers: {'Content-Type': 'application/json'}});
          alert(`Bulk notify attempted. Sent: ${resp.sent || 0}, Failed: ${resp.failed || 0}`);
        }catch(e){
          alert('Bulk notify failed (network/error).');
        }
      });
    }

    // Per-department notify buttons
    document.querySelectorAll('.dept-notify-btn').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const deptId = this.getAttribute('data-dept-id');
        const message = prompt('Enter notification message for this group (leave blank for default):');
        try{
          const body = JSON.stringify({message: message});
          const resp = await apiFetch(`/dashboard/api/departments/${deptId}/notify/`, {method: 'POST', body: body, headers: {'Content-Type': 'application/json'}});
          alert(`Notify attempted. Sent: ${resp.sent || 0}, Failed: ${resp.failed || 0}`);
        }catch(e){
          alert('Notify failed (network/error).');
        }
      });
    });
  });
</script>
<!-- Group Members Modal -->
<div id="groupMembersModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
  <div class="w-full max-w-2xl rounded-lg bg-white p-6">
    <div class="flex items-start justify-between">
      <h3 id="groupMembersTitle" class="text-lg font-semibold">Group Members</h3>
      <button onclick="document.getElementById('groupMembersModal').classList.add('hidden')" class="text-gray-500">Close</button>
    </div>
    <div id="groupMembersBody" class="mt-4">
      <div class="mb-3">
        <label class="text-xs text-gray-600">Add user by ID</label>
        <div class="flex items-center gap-2 mt-1">
          <input autocomplete="off" id="addMemberUserId" class="rounded border border-gray-200 px-3 py-2 w-full" placeholder="User ID" />
          <button id="addMemberBtn" class="rounded bg-sky-600 text-white px-3 py-2">Add</button>
        </div>
      </div>
      <div id="groupMembersList" class="space-y-2">
        <!-- members loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
function openGroupMembersModal(groupId, groupName){
  const modal = document.getElementById('groupMembersModal');
  const title = document.getElementById('groupMembersTitle');
  const bodyList = document.getElementById('groupMembersList');
  title.textContent = 'Members — ' + (groupName || groupId);
  bodyList.innerHTML = '<p class="text-sm text-gray-500">Loading...</p>';
  modal.classList.remove('hidden');

  fetch(`/dashboard/api/groups/${groupId}/members/`)
    .then(r => r.json())
    .then(j => {
      const members = j.members || [];
      if(members.length === 0){
        bodyList.innerHTML = '<p class="text-sm text-gray-500">No members.</p>';
      } else {
        bodyList.innerHTML = '';
        members.forEach(m => {
          const row = document.createElement('div');
          row.className = 'flex items-center justify-between p-2 bg-neutral-50 rounded';
          row.innerHTML = `<div class="min-w-0"><div class="text-sm font-medium text-gray-900">${m.username||m.full_name||'User'}</div><div class="text-xs text-gray-500">${m.email||''}</div></div><div><button class="text-red-600 text-xs" onclick="removeMember(${groupId}, ${m.id})">Remove</button></div>`;
          bodyList.appendChild(row);
        });
      }
    }).catch(()=>{ bodyList.innerHTML = '<p class="text-sm text-red-500">Failed to load members.</p>' });

  document.getElementById('addMemberBtn').onclick = function(){
    const uid = document.getElementById('addMemberUserId').value.trim();
    if(!uid) return alert('Enter user id');
    fetch(`/dashboard/manage-users/groups/${groupId}/add-member/`, {method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value||getCookie('csrftoken')}, body: `user_id=${encodeURIComponent(uid)}`})
      .then(r=>r.json()).then(j=>{ if(j.success){ openGroupMembersModal(groupId, groupName); } else alert('Failed: '+(j.error||'unknown')) }).catch(()=>alert('Add failed'));
  };
}

function removeMember(groupId, userId){
  if(!confirm('Remove user from group?')) return;
  fetch(`/dashboard/manage-users/groups/${groupId}/remove-member/`, {method: 'POST', headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value||getCookie('csrftoken')}, body: `user_id=${encodeURIComponent(userId)}`})
    .then(r=>r.json()).then(j=>{ if(j.success){ document.getElementById('groupMembersModal').classList.remove('hidden'); openGroupMembersModal(groupId); } else alert('Failed: '+(j.error||'unknown')) }).catch(()=>alert('Remove failed'));
}

function openGroupEdit(groupId, groupName){
  // Simple fallback: prompt to rename group
  const newName = prompt('Rename group '+ (groupName||groupId) + '\n(Leave blank to cancel)');
  if(!newName) return;
  // naive POST to update group via existing group_update view
  fetch(`/dashboard/groups/${groupId}/update/`, {method:'POST', headers: {'Content-Type':'application/x-www-form-urlencoded','X-CSRFToken': (document.querySelector('input[name=csrfmiddlewaretoken]')||{}).value||getCookie('csrftoken')}, body: `name=${encodeURIComponent(newName)}`})
    .then(()=>location.reload())
    .catch(()=>alert('Failed to update group'));
}

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>
{% endblock extra_js %}